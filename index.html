<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
  <script>
    // === CONFIGURE THESE ===
    const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3bXRicGZreWx4dnl2c2RlcHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg5NjE0MTQsImV4cCI6MjA2NDUzNzQxNH0.pmpGh4dWJNGZ23BLOQ7fVeyZ-10o9QW2SMuGYBbWrEU";
    const PROJECT_URL = "https://bwmtbpfkylxvyvsdepvl.supabase.co";
    const BASE_URL    = `${PROJECT_URL}/rest/v1`;
    const connector   = tableau.makeConnector();

    // 1) Define schema per table
    connector.getSchema = schemaCallback => {
      const tbl = tableau.connectionData;
      if (!tbl) {
        tableau.abortWithError("No table selected. Click one of the buttons below.");
        return;
      }

      let cols = [], tableSchema;
      switch(tbl) {
        case "final_composite_scores":
          cols = [
            { id: "id",            alias: "id",            dataType: tableau.dataTypeEnum.int    },
            { id: "country_name",  alias: "country_name",  dataType: tableau.dataTypeEnum.string },
            { id: "country_code",  alias: "country_code",  dataType: tableau.dataTypeEnum.string },
            { id: "scenario",      alias: "scenario",      dataType: tableau.dataTypeEnum.string },
            { id: "score",         alias: "score",         dataType: tableau.dataTypeEnum.float  }
          ];
          break;
        case "country_region_IBAN":
          cols = [
            { id: "region_code",         alias: "region_code",          dataType: tableau.dataTypeEnum.int    },
            { id: "region_name",         alias: "region_name",          dataType: tableau.dataTypeEnum.string },
            { id: "sub_region_code",     alias: "sub_region_code",      dataType: tableau.dataTypeEnum.int    },
            { id: "sub_region_name",     alias: "sub_region_name",      dataType: tableau.dataTypeEnum.string },
            { id: "country",             alias: "country",              dataType: tableau.dataTypeEnum.string },
            { id: "numeric",             alias: "numeric",              dataType: tableau.dataTypeEnum.int    },
            { id: "iso_alpha2",          alias: "iso_alpha2",           dataType: tableau.dataTypeEnum.string },
            { id: "iso_alpha3",          alias: "iso_alpha3",           dataType: tableau.dataTypeEnum.string },
            { id: "ge_healthcare_region",alias: "ge_healthcare_region", dataType: tableau.dataTypeEnum.string }
          ];
          break;
        case "OECD_dashboard_data":
          cols = [
            { id: "id",            alias: "id",             dataType: tableau.dataTypeEnum.int    },
            { id: "date",          alias: "date",           dataType: tableau.dataTypeEnum.date   },
            { id: "country_code",  alias: "country_code",   dataType: tableau.dataTypeEnum.string },
            { id: "country_name",  alias: "country_name",   dataType: tableau.dataTypeEnum.string },
            { id: "indicator",     alias: "indicator",      dataType: tableau.dataTypeEnum.string },
            { id: "value",         alias: "value",          dataType: tableau.dataTypeEnum.float  }
          ];
          break;
        case "allianz_dashboard_data":
          cols = [
            { id: "id",           alias: "id",            dataType: tableau.dataTypeEnum.int    },
            { id: "date",         alias: "date",          dataType: tableau.dataTypeEnum.date   },
            { id: "country_code", alias: "country_code",  dataType: tableau.dataTypeEnum.string },
            { id: "country_name", alias: "country_name",  dataType: tableau.dataTypeEnum.string },
            { id: "indicator",    alias: "indicator",     dataType: tableau.dataTypeEnum.string },
            { id: "value",        alias: "value",         dataType: tableau.dataTypeEnum.string }
          ];
          break;
        case "imf_dashboard_data":
          cols = [
            { id: "id",               alias: "id",                dataType: tableau.dataTypeEnum.int    },
            { id: "date",             alias: "date",              dataType: tableau.dataTypeEnum.date   },
            { id: "country_full_name",alias: "country_full_name", dataType: tableau.dataTypeEnum.string },
            { id: "country_code",     alias: "country_code",      dataType: tableau.dataTypeEnum.string },
            { id: "indicator",        alias: "indicator",         dataType: tableau.dataTypeEnum.string },
            { id: "value",            alias: "value",             dataType: tableau.dataTypeEnum.float  }
          ];
          break;
        case "sovereign_ratings_dashboard_data":
          cols = [
            { id: "id",           alias: "id",           dataType: tableau.dataTypeEnum.int    },
            { id: "date",         alias: "date",         dataType: tableau.dataTypeEnum.date   },
            { id: "country_name", alias: "country_name", dataType: tableau.dataTypeEnum.string },
            { id: "agency",       alias: "agency",       dataType: tableau.dataTypeEnum.string },
            { id: "rating",       alias: "rating",       dataType: tableau.dataTypeEnum.string }
          ];
          break;
        case "wgi_dashboard_data_yearly":
          cols = [
            { id: "id",           alias: "id",            dataType: tableau.dataTypeEnum.int    },
            { id: "date",         alias: "date",          dataType: tableau.dataTypeEnum.date   },
            { id: "country_code", alias: "country_code",  dataType: tableau.dataTypeEnum.string },
            { id: "country_name", alias: "country_name",  dataType: tableau.dataTypeEnum.string },
            { id: "indicator",    alias: "indicator",     dataType: tableau.dataTypeEnum.string },
            { id: "value",        alias: "value",         dataType: tableau.dataTypeEnum.float  }
          ];
          break;
        default:
          tableau.abortWithError("Unknown table: " + tbl);
          return;
      }

      const tableSchema = { id: tbl, alias: tbl, columns: cols };
      schemaCallback([tableSchema]);
    };

    // 2) Fetch & page data
    connector.getData = (table, doneCallback) => {
      const tbl     = tableau.connectionData;
      const headers = {
        "apikey":        ANON_KEY,
        "Authorization": `Bearer ${ANON_KEY}`,
        "Content-Type":  "application/json"
      };
      const pageSize = 1000;
      let offset     = 0;

      function fetchPage() {
        const url = `${BASE_URL}/${tbl}?select=*&limit=${pageSize}&offset=${offset}`;
        fetch(url, { headers })
          .then(res => {
            if (!res.ok) throw new Error(`Status ${res.status}`);
            return res.json();
          })
          .then(data => {
            if (!data.length) {
              doneCallback();
              return;
            }
            const rows = data.map(r => {
              const out = {};
              for (const col of table.tableInfo.columns) {
                out[col.id] = r[col.id];
              }
              return out;
            });
            table.appendRows(rows);
            if (data.length === pageSize) {
              offset += pageSize;
              fetchPage();
            } else {
              doneCallback();
            }
          })
          .catch(err => tableau.abortWithError(`Fetch error: ${err.message}`));
      }
      fetchPage();
    };

    // 3) Register connector
    tableau.registerConnector(connector);

    // 4) Expose launch() globally
    function launch(tbl) {
      tableau.connectionData   = tbl;
      tableau.connectionName   = tbl;
      tableau.submit();
    }
    window.launch = launch;
  </script>
</head>
<style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f8fa;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    h2 {
      margin-top: 0;
      font-size: 1.75em;
      color: #1a1a1a;
    }
    p {
      margin: 0 0 1.5em;
      color: #555;
    }
    button {
      display: inline-block;
      margin: 0.25em;
      padding: 0.6em 1.2em;
      font-size: 1em;
      font-weight: 500;
      color: #fff;
      background-color: #007acc;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      text-decoration: none;
    }
    .btn:hover {
      background-color: #005fa3;
    }
  </style>
<body>
  <div class="container">
    <h2>ðŸ“Š Supabase â†’ Tableau Public</h2>
    <p>Select the dataset youâ€™d like to import:</p>
    <div>
      <button onclick="launch('final_composite_scores')">Composite Scores</button>
      <button onclick="launch('country_region_IBAN')">Country Region (IBAN)</button>
      <button onclick="launch('OECD_dashboard_data')">OECD Data</button>
      <button onclick="launch('allianz_dashboard_data')">Allianz Data</button>
      <button onclick="launch('imf_dashboard_data')">IMF Data</button>
      <button onclick="launch('sovereign_ratings_dashboard_data')">Sovereign Ratings</button>
      <button onclick="launch('wgi_dashboard_data_yearly')">WGI (Yearly)</button>
    </div>
  </div>
</body>
</html>
